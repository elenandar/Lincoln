/*
Module: Input â€” Lincoln v17.0.0-phase1
Contract:
- Phase 1: Infrastructure Layer Implementation
- Handles command parsing and execution
- Detects and tracks action types (do/say/story)
- Increments turn counter on each input
*/

// === INPUT MODIFIER v17.0.0-phase1 ===
const __SCRIPT_SLOT__ = "Input";

const modifier = function(text) {
  // Safe text handling
  var raw = String(text || "");
  var userText = raw.trim();
  
  // Check if LC is available
  if (typeof LC === "undefined") {
    return { text: raw };
  }
  
  // Initialize for this slot
  var L = LC.lcInit(__SCRIPT_SLOT__);
  
  // Increment turn counter at start of each input
  if (LC.Turns) {
    LC.Turns.increment();
  }
  
  // Command detection (slash commands)
  if (userText.charAt(0) === "/") {
    var parts = userText.slice(1).split(/\s+/);
    var cmdName = parts[0].toLowerCase();
    
    // Skip if command name is empty (just "/" typed)
    if (!cmdName) {
      return { text: raw };
    }
    
    var args = parts.slice(1);
    
    // Check if command exists
    if (LC.Commands && LC.Commands.has(cmdName)) {
      // Execute command and add result to Drafts queue
      var result = LC.Commands.execute(cmdName, args);
      if (LC.Drafts && result) {
        LC.Drafts.add(result);
      }
      // Return space with stop:true to prevent AI generation
      return { text: " ", stop: true };
    }
  }
  
  // Detect action type from user input
  if (LC.currentAction && userText) {
    LC.currentAction.detect(userText);
  }
  
  // Pass through user input
  return { text: raw };
};

// Execute modifier and return result
return modifier(text);
