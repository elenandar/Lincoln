# PROJECT LINCOLN v17: MASTER PLAN

**Версия:** 1.0  
**Дата:** 25 октября 2025  
**Статус:** Канонический план разработки  
**Единственный источник правды для v17**

---

## СОДЕРЖАНИЕ

1. [Введение: Уроки v16 и Цели v17](#введение-уроки-v16-и-цели-v17)
2. [Архитектурные Принципы](#архитектурные-принципы)
3. [Дорожная Карта Разработки](#дорожная-карта-разработки)
4. [Принципы Тестирования](#принципы-тестирования)
5. [Критические Правила](#критические-правила)
6. [Граф Зависимостей](#граф-зависимостей)

---

## ВВЕДЕНИЕ: УРОКИ V16 И ЦЕЛИ V17

### Что Было Достигнуто в v16

Проект Lincoln v16.0.8 представляет собой **завершенную и верифицированную систему** симуляции динамических социальных миров. Система успешно прошла:
- Полный статический аудит (100% качества кода)
- Динамический стресс-тест на 1000 ходов
- Подтверждение стабильности, производительности и функциональности

**Ключевые инновации v16:**
- Четырехуровневая модель сознания ("Каскад Формирования Реальности")
- Субъективная интерпретация событий через InformationEngine
- Репутация через субъективные восприятия (perceptions)
- Культурная память через легенды и мифы
- 40 взаимосвязанных систем, работающих как единый организм

### Почему Нужна v17

После анализа архитектуры v16 и изучения официальных руководств по скриптингу AI Dungeon стало ясно, что **первоначальный план v17 был технически наивным** из-за неправильного понимания ограничений платформы.

**Главное открытие:** AI Dungeon не поддерживает нативную модульность (нет `require()` или `import`). Все попытки разделить код на независимые модули обречены на провал.

**Следствие:** Вся архитектура v17 должна быть пересмотрена с учетом этого ограничения.

### Цели v17

1. **Сохранить все инновации v16** — четырехуровневую модель сознания, субъективную интерпретацию, репутацию через восприятия
2. **Адаптировать под реальность AI Dungeon** — реализовать логическую изоляцию без физической модульности
3. **Обеспечить инкрементальную разработку** — строить систему поэтапно, тестируя каждый компонент в игре
4. **Избежать технического долга** — внедрять системы в правильном порядке зависимостей
5. **Написать код с чистого листа** — не копировать из v16, а переосмыслить каждую систему

---

## АРХИТЕКТУРНЫЕ ПРИНЦИПЫ

### Принцип 1: Library.txt и Глобальный Объект LC

**Решение:** Весь код инициализации будет находиться в скрипте `Library.txt`, который выполняется при загрузке игры.

```javascript
// Library.txt
const LC = {
  // Утилиты
  Tools: { /* safeRegexMatch, etc */ },
  Utils: { /* общие функции */ },
  
  // Движки (логически изолированные объекты)
  QualiaEngine: { /* методы и внутреннее состояние */ },
  InformationEngine: { /* методы и внутреннее состояние */ },
  RelationsEngine: { /* методы и внутреннее состояние */ },
  HierarchyEngine: { /* методы и внутреннее состояние */ },
  // ... и так далее
  
  // Инициализация
  lcInit: function() {
    // Создание структуры state.lincoln
  }
};

// Делаем LC доступным глобально
state.shared.LC = LC;
```

**Ключевая идея:** LC — это единый глобальный объект, содержащий все движки как **логически изолированные компоненты**. Каждый движок — это независимый объект со своими методами и (опционально) приватными переменными.

### Принцип 2: Логическая Изоляция Движков

**Важно:** Несмотря на отсутствие физической модульности, мы **строго соблюдаем логическую изоляцию**.

**Правила взаимодействия:**
1. ✅ **Разрешено:** Вызывать публичные методы других движков
   ```javascript
   // RelationsEngine использует InformationEngine
   const interpretation = LC.InformationEngine.interpret(character, event);
   modifier *= interpretation.multiplier;
   ```

2. ❌ **Запрещено:** Прямой доступ к внутреннему состоянию других движков
   ```javascript
   // НЕПРАВИЛЬНО: прямое чтение чужого состояния
   const valence = state.lincoln.qualia_state[character].valence;
   
   // ПРАВИЛЬНО: через публичный метод
   const valence = LC.QualiaEngine.getValence(character);
   ```

3. ✅ **Разрешено:** Чтение и запись в `state.lincoln` (общее хранилище данных)
   ```javascript
   // Каждый движок управляет своей областью в state.lincoln
   state.lincoln.relations[from][to] = value;
   ```

**Структура state.lincoln:**
```javascript
state.lincoln = {
  // Управляемые данные (каждый движок управляет своей областью)
  characters: {},      // QualiaEngine, CrucibleEngine
  relations: {},       // RelationsEngine
  hierarchy: {},       // HierarchyEngine
  rumors: [],          // GossipEngine
  lore: [],            // LoreEngine
  myths: [],           // MemoryEngine
  // ... и т.д.
  
  // Мета-данные
  turn: 0,             // TimeEngine
  time: {},            // TimeEngine
  environment: {}      // EnvironmentEngine
};
```

### Принцип 3: Инкрементальная Разработка по Фазам

**Стратегия:** Мы НЕ строим всю систему сразу. Мы создаем её поэтапно, начиная с **пустого, но рабочего скелета**.

**Фаза 0: Нулевая Система**
- Создать четыре пустых скрипта: `Input.txt`, `Output.txt`, `Context.txt`, `Library.txt`
- Скрипты успешно загружаются в игре, но ничего не делают
- Это наша точка отсчета

**Далее:** Добавляем по одному движку за раз, согласно дорожной карте (см. ниже).

### Принцип 4: Каскадная Модель Зависимостей

**Ключевое открытие:** После анализа всех 40 систем v16 установлено, что существует **строгий порядок зависимостей**, нарушение которого приводит к техническому долгу.

**Критическая пара #1: QualiaEngine → InformationEngine**

```javascript
// InformationEngine НЕ МОЖЕТ работать без QualiaEngine
InformationEngine.interpret = function(character, event) {
  const valence = character.qualia_state.valence;  // ← Читает qualia_state
  
  if (valence > 0.7) {
    return { interpretation: "искренне", multiplier: 1.5 };
  } else if (valence < 0.3) {
    return { interpretation: "саркастично", multiplier: 0.4 };
  }
};
```

**Тип зависимости:** BLOCKING (блокирующая)  
**Следствие:** QualiaEngine ОБЯЗАН быть внедрен ПЕРЕД InformationEngine. Это безальтернативно.

**Критическая пара #2: InformationEngine → RelationsEngine**

```javascript
// RelationsEngine НУЖДАЕТСЯ в InformationEngine для субъективной интерпретации
RelationsEngine.updateRelation = function(from, to, modifier, options) {
  if (options.interpretedEvent) {
    const interpretation = LC.InformationEngine.interpret(from, options.interpretedEvent);
    modifier *= interpretation.multiplier;  // ← Использует InformationEngine
  }
  
  state.lincoln.relations[from][to] += modifier;
};
```

**Тип зависимости:** FUNCTIONAL (функциональная)  
**Следствие:** RelationsEngine ЛУЧШЕ внедрять ПОСЛЕ InformationEngine, чтобы сразу иметь субъективные интерпретации. Иначе придется рефакторить.

**Критическая пара #3: InformationEngine → HierarchyEngine**

```javascript
// HierarchyEngine использует InformationEngine для расчета репутации (ключевая инновация v16)
HierarchyEngine._getAverageWitnessRespect = function(character) {
  let totalRespect = 0;
  
  for (const witness of witnesses) {
    const perception = LC.InformationEngine.getPerception(witness, character);
    totalRespect += perception.respect;  // ← Субъективная оценка
  }
  
  return totalRespect / witnesses.length;
};
```

**Тип зависимости:** FUNCTIONAL (функциональная)  
**Следствие:** HierarchyEngine ДОЛЖЕН быть внедрен ПОСЛЕ InformationEngine, чтобы сохранить ключевую инновацию v16.

### Принцип 5: Тестирование на Каждом Шаге

**Правило:** После внедрения КАЖДОГО компонента проводится обязательный запуск в игре AI Dungeon.

**Методы тестирования:**
1. **Команды для отладки** — например, `/qualia set Alice valence 0.8`
2. **Автоматический анализ текста** — система должна корректно обрабатывать сюжетные действия
3. **Проверка стабильности** — отсутствие ошибок в консоли, корректное сохранение состояния

**Критерий успеха:** Игра стабильно работает, новый компонент выполняет свою функцию, данные корректно сохраняются в `state.lincoln`.

---

## ДОРОЖНАЯ КАРТА РАЗРАБОТКИ

### ФАЗА 0: НУЛЕВАЯ СИСТЕМА

**Цель:** Создать пустые, но рабочие скрипты.

**Задачи:**
1. Создать `Library.txt` с пустым объектом `LC`
2. Создать `Input.txt`, `Output.txt`, `Context.txt` с минимальной логикой
3. Проверить, что игра загружается без ошибок

**Критерий успеха:** Игра успешно запускается, скрипты не вызывают ошибок.

**Срок:** 1 день

---

### ФАЗА 1: ИНФРАСТРУКТУРА

**Цель:** Создать базовый каркас для управления состоянием и отладки.

**Системы:** #19-24, #33-34

| Компонент | Назначение | Реализация |
|-----------|-----------|-----------|
| **lcInit** (#33) | Централизованная инициализация | Функция `LC.lcInit()` создает структуру `state.lincoln` |
| **currentAction** (#34) | Отслеживание типа действия | Объект `state.lincoln.currentAction` с полем `type` |
| **CommandsRegistry** (#24) | Реестр команд | Map для хранения команд. `Input.txt` парсит `/команда` |
| **LC.Tools** (#19) | Утилиты безопасности | `safeRegexMatch()`, `escapeRegex()` |
| **LC.Utils** (#20) | Общие утилиты | `toNum()`, `toStr()`, `toBool()` |
| **LC.Flags** (#21) | Фасад совместимости | Обертка над `currentAction` |
| **LC.Drafts** (#22) | Управление черновиками | Очередь сообщений для вывода |
| **LC.Turns** (#23) | Управление ходами | Счетчик ходов |

**Команды для тестирования:**
- `/ping` → ответ `pong`
- `/debug` → вывод состояния системы
- `/turn` → показать текущий ход

**Критерий успеха:** Команды работают, система корректно отслеживает тип действия.

**Срок:** 1-2 дня

---

### ФАЗА 2: ФИЗИЧЕСКИЙ МИР

**Цель:** Заложить основы пространства и времени.

**Системы:** #7, #8, #18

| Компонент | Назначение | Реализация |
|-----------|-----------|-----------|
| **TimeEngine** (#7) | Внутриигровое время | Структура `state.lincoln.time`, счетчик `state.lincoln.turn` |
| **EnvironmentEngine** (#8) | Локации и погода | Структура `state.lincoln.environment` |
| **ChronologicalKnowledgeBase** (#18) | Временная база знаний | Опционально: события с временными метками |

**Команды для тестирования:**
- `/time` → показать текущее время
- `/weather set rain` → установить погоду
- `/location set home` → установить локацию

**Критерий успеха:** Время течет (инкремент на каждом ходе), окружение изменяется командами.

**Срок:** 1-2 дня

---

### ФАЗА 3: БАЗОВЫЕ ДАННЫЕ

**Цель:** Реализовать системы для хранения фактов, целей и секретов.

**Системы:** #1, #2, #6

| Компонент | Назначение | Реализация |
|-----------|-----------|-----------|
| **EvergreenEngine** (#1) | Долговременная память | Массив `state.lincoln.evergreen` для фактов |
| **GoalsEngine** (#2) | Цели персонажей | Объект `state.lincoln.goals` |
| **KnowledgeEngine** (#6) | Секреты и фокус | Массив `state.lincoln.secrets` |

**Команды для тестирования:**
- `/fact add "Alice любит яблоки"` → добавить факт
- `/goal add Alice "стать лидером"` → добавить цель
- `/secret add Alice "знает о заговоре"` → добавить секрет

**Критерий успеха:** Данные сохраняются в `state.lincoln`, доступны для чтения.

**Срок:** 2-3 дня

---

### ФАЗА 4: СОЗНАНИЕ — КРИТИЧЕСКАЯ ФАЗА

**⚠️ САМЫЙ ВАЖНЫЙ ЭТАП ВСЕГО ПРОЕКТА ⚠️**

**Цель:** Реализовать фундамент четырехуровневой модели сознания.

**Системы:** #15, #5

**⚠️ ВНИМАНИЕ:** Эти две системы должны быть внедрены **ПОСЛЕДОВАТЕЛЬНО** и **БЕЗ ПЕРЕРЫВА**. Нельзя откладывать InformationEngine "на потом".

#### Шаг 4.1: QualiaEngine (#15)

**Назначение:** Феноменальное ядро — сырые телесные ощущения.

**Структура данных:**
```javascript
state.lincoln.characters[name].qualia_state = {
  somatic_tension: 0.5,  // Напряжение (0.0 - 1.0)
  valence: 0.5,          // Приятно/неприятно (0.0 - 1.0)
  focus_aperture: 0.5,   // Фокус внимания (0.0 - 1.0)
  energy_level: 0.5      // Энергия (0.0 - 1.0)
};
```

**Публичные методы:**
```javascript
LC.QualiaEngine = {
  resonate: function(character, event) {
    // Изменить qualia_state на основе события
  },
  
  getValence: function(character) {
    return state.lincoln.characters[character].qualia_state.valence;
  },
  
  // ... другие геттеры
};
```

**Команда для тестирования:**
- `/qualia set Alice valence 0.8` → установить валентность

**Критерий успеха:** Команда изменяет `qualia_state`, значение сохраняется.

**Срок:** 1-2 дня

#### Шаг 4.2: InformationEngine (#5)

**Назначение:** Субъективная интерпретация событий.

**⚠️ ВНИМАНИЕ:** InformationEngine ОБЯЗАН быть реализован СРАЗУ ПОСЛЕ QualiaEngine.

**Структура данных:**
```javascript
state.lincoln.characters[name].perceptions = {
  [otherCharacter]: {
    trust: 0.5,
    respect: 0.5,
    competence: 0.5
  }
};
```

**Публичные методы:**
```javascript
LC.InformationEngine = {
  interpret: function(character, event) {
    const valence = LC.QualiaEngine.getValence(character);
    
    if (valence > 0.7) {
      return { interpretation: "искренне", multiplier: 1.5 };
    } else if (valence < 0.3) {
      return { interpretation: "саркастично", multiplier: 0.4 };
    } else {
      return { interpretation: "нейтрально", multiplier: 1.0 };
    }
  },
  
  getPerception: function(observer, target) {
    return state.lincoln.characters[observer].perceptions[target] || { trust: 0.5, respect: 0.5, competence: 0.5 };
  }
};
```

**Команда для тестирования:**
- `/interpret Alice praise` → интерпретировать событие "похвала"

**Критерий успеха:** Одно и то же событие интерпретируется по-разному в зависимости от `valence`. Например:
- При `valence = 0.8` → "искренне" (multiplier 1.5)
- При `valence = 0.2` → "саркастично" (multiplier 0.4)

**Срок:** 2-3 дня

**Общий срок Фазы 4:** 3-5 дней

---

### ФАЗА 5: СОЦИАЛЬНАЯ ДИНАМИКА

**Цель:** Ввести персонажей и симуляцию социальных взаимодействий.

**Системы:** #3, #4, #16

| Компонент | Назначение | Реализация |
|-----------|-----------|-----------|
| **MoodEngine** (#3) | Настроения персонажей | Структура `state.lincoln.character_status[name].mood` |
| **RelationsEngine** (#4) | Управление отношениями | Объект `state.lincoln.relations[from][to]` с интеграцией InformationEngine |
| **CrucibleEngine** (#16) | Эволюция характера | Структура `state.lincoln.characters[name].self_concept` |

**⚠️ ВАЖНО:** RelationsEngine реализуется С ИСПОЛЬЗОВАНИЕМ InformationEngine сразу. Никаких "половинчатых" версий.

**Команды для тестирования:**
- `/relation set Alice Bob 50` → установить отношение
- `/mood set Alice happy` → установить настроение
- `/event trigger Alice betrayal` → вызвать событие предательства

**Критерий успеха:** Система автоматически анализирует текст, обновляет отношения с учетом субъективных интерпретаций, изменяет self_concept при формирующих событиях.

**Срок:** 3-4 дня

---

### ФАЗА 6: СОЦИАЛЬНАЯ ИЕРАРХИЯ

**Цель:** Реализовать социальные статусы и слухи.

**Системы:** #10, #11, #9

| Компонент | Назначение | Реализация |
|-----------|-----------|-----------|
| **HierarchyEngine** (#10) | Социальная иерархия | Расчет статусов через InformationEngine.perceptions |
| **GossipEngine** (#9) | Система слухов | Массив `state.lincoln.rumors` с credibility |
| **SocialEngine** (#11) | Нормы и конформизм | Структура `state.lincoln.society.norms` |

**⚠️ ВАЖНО:** HierarchyEngine использует `InformationEngine.getPerception()` для расчета репутации. Это ключевая инновация v16.

**Команды для тестирования:**
- `/capital set Alice 110` → установить социальный капитал
- `/rumor add "Слух о..." about Alice` → добавить слух
- `/status Alice` → показать статус персонажа

**Критерий успеха:** Репутация рассчитывается через субъективные восприятия, слухи распространяются с учетом credibility.

**Срок:** 2-3 дня

---

### ФАЗА 7: КУЛЬТУРНАЯ ПАМЯТЬ

**Цель:** Ввести высший уровень симуляции — коллективную память и историю.

**Системы:** #12, #13, #14, #17

| Компонент | Назначение | Реализация |
|-----------|-----------|-----------|
| **MemoryEngine** (#12) | Мифологизация памяти | Массив `state.lincoln.myths`, кристаллизация из formative_events |
| **LoreEngine** (#13) | Школьные легенды | Массив `state.lincoln.lore` |
| **AcademicsEngine** (#14) | Академическая активность | Структура `state.lincoln.academics` |
| **DemographicPressure** (#17) | Введение новых персонажей | Функция calibrateToZeitgeist |

**Команды для тестирования:**
- `/myth add "Миф о..."` → добавить миф
- `/lore add "Легенда о..."` → добавить легенду

**Критерий успеха:** Легенды кристаллизуются из событий, мифы формируются автоматически из архива формирующих событий (CrucibleEngine).

**Срок:** 2-3 дня

---

### ФАЗА 8: ОПТИМИЗАЦИЯ И ИНТЕГРАЦИЯ

**Цель:** Координация всех движков и оптимизация производительности.

**Системы:** #29-32

| Компонент | Назначение | Реализация |
|-----------|-----------|-----------|
| **State Versioning** (#30) | Версионирование состояния | Поле `state.lincoln._version` |
| **Context Caching** (#31) | Кэширование контекста | Кэш для `composeContextOverlay` |
| **Norm Cache** (#32) | Кэширование нормализации | Кэш для normalizedText |
| **UnifiedAnalyzer** (#29) | Единый конвейер анализа | Координатор всех движков |

**⚠️ ВАЖНО:** UnifiedAnalyzer внедряется ПОСЛЕДНИМ, когда все движки готовы.

**Критерий успеха:** Все движки координируются через единый конвейер, оптимизация работает корректно.

**Срок:** 2-3 дня

---

## ПРИНЦИПЫ ТЕСТИРОВАНИЯ

### Тестирование на Каждом Шаге

**Обязательно:** После внедрения КАЖДОГО компонента проводится запуск в игре AI Dungeon.

**Методы:**
1. **Команды отладки** — `/ping`, `/debug`, `/qualia set`, `/interpret`
2. **Автоматический анализ** — система должна корректно обрабатывать сюжетные действия
3. **Проверка стабильности** — отсутствие ошибок, корректное сохранение

### Критерии Успеха

**Для каждой фазы:**
- Игра стабильно работает
- Новый компонент выполняет свою функцию
- Данные корректно сохраняются в `state.lincoln`
- Нет конфликтов с предыдущими компонентами

### Регрессионное Тестирование

**После добавления нового компонента:**
- Проверить, что все предыдущие команды работают
- Убедиться, что старые данные не повреждены
- Протестировать взаимодействие с ранее внедренными движками

---

## КРИТИЧЕСКИЕ ПРАВИЛА

### Правило #1: QualiaEngine → InformationEngine ПОСЛЕДОВАТЕЛЬНО

**⚠️ БЕЗАЛЬТЕРНАТИВНО:** QualiaEngine и InformationEngine должны быть внедрены **подряд**, **без перерыва**, **без других движков между ними**.

**Почему:**
- InformationEngine НЕ МОЖЕТ работать без QualiaEngine (блокирующая зависимость)
- Откладывать InformationEngine = создавать заглушки = бессмысленная работа

### Правило #2: InformationEngine ДО RelationsEngine и HierarchyEngine

**⚠️ КРИТИЧНО:** Социальные системы (RelationsEngine, HierarchyEngine) должны быть внедрены ПОСЛЕ InformationEngine.

**Почему:**
- Иначе придется реализовать "половинчатую" версию RelationsEngine
- Потом рефакторить для интеграции InformationEngine
- Двойная работа + технический долг

### Правило #3: UnifiedAnalyzer ПОСЛЕДНИМ

**⚠️ ОБЯЗАТЕЛЬНО:** UnifiedAnalyzer внедряется ПОСЛЕ всех движков.

**Почему:**
- UnifiedAnalyzer — это координатор, который вызывает все движки
- Если движков нет, координировать нечего

### Правило #4: Код с Чистого Листа

**⚠️ ЗАПРЕЩЕНО:** Копировать код из v16.

**Разрешено:**
- Читать аудиторский отчет v16
- Понимать идею каждой системы
- Переосмысливать и писать заново

**Почему:**
- Код v16 был написан для другой архитектуры
- Прямое копирование приведет к ошибкам

### Правило #5: Один Движок за Раз

**⚠️ ОБЯЗАТЕЛЬНО:** Никаких параллельных разработок.

**Процесс:**
1. Внедрить один движок
2. Протестировать в игре
3. Убедиться в стабильности
4. Только потом переходить к следующему

---

## ГРАФ ЗАВИСИМОСТЕЙ

### Визуализация Критического Пути

```
┌─────────────────────────────────────────────────────────────────┐
│                    ФАЗА 0: НУЛЕВАЯ СИСТЕМА                      │
│  Пустые, но рабочие скрипты (Input, Output, Context, Library)  │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ФАЗА 1: ИНФРАСТРУКТУРА                       │
│  lcInit → currentAction → CommandsRegistry → LC.Tools/Utils     │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                   ФАЗА 2: ФИЗИЧЕСКИЙ МИР                        │
│       TimeEngine → EnvironmentEngine → (CKB опционально)        │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                   ФАЗА 3: БАЗОВЫЕ ДАННЫЕ                        │
│       EvergreenEngine, GoalsEngine, KnowledgeEngine             │
│                  (в любом порядке)                              │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
╔═════════════════════════════════════════════════════════════════╗
║          ⚠️  ФАЗА 4: СОЗНАНИЕ — КРИТИЧЕСКАЯ ФАЗА  ⚠️            ║
║                                                                 ║
║  ┌────────────────────────────────────────────────────────┐    ║
║  │              QualiaEngine (#15)                        │    ║
║  │         Феноменология (Уровень 1)                      │    ║
║  │  • somatic_tension, valence, focus, energy             │    ║
║  └──────────────────────┬─────────────────────────────────┘    ║
║                         │                                       ║
║                         │ БЛОКИРУЮЩАЯ ЗАВИСИМОСТЬ              ║
║                         │ (InformationEngine НЕ МОЖЕТ работать  ║
║                         │  без QualiaEngine.qualia_state)       ║
║                         ▼                                       ║
║  ┌────────────────────────────────────────────────────────┐    ║
║  │          InformationEngine (#5)                        │    ║
║  │       Субъективная реальность (Уровень 2)             │    ║
║  │  • interpret(character, event) ← читает qualia_state   │    ║
║  │  • perceptions: trust, respect, competence             │    ║
║  └────────────────────────────────────────────────────────┘    ║
║                                                                 ║
║  ⚠️  Эти ДВЕ системы ДОЛЖНЫ быть внедрены ПОСЛЕДОВАТЕЛЬНО,     ║
║      БЕЗ ПЕРЕРЫВА, ДО социальных систем                        ║
╚═════════════════════════════════════════════════════════════════╝
                               │
                               │ ФУНКЦИОНАЛЬНЫЕ ЗАВИСИМОСТИ
                               │ (RelationsEngine и HierarchyEngine
                               │  НУЖДАЮТСЯ в InformationEngine)
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
┌─────────────────┐  ┌──────────────────┐  ┌──────────────┐
│  MoodEngine     │  │ RelationsEngine  │  │  Crucible    │
│     (#3)        │  │      (#4)        │  │ Engine (#16) │
│                 │  │                  │  │              │
│ Эмоции и        │  │ С ИНТЕГРАЦИЕЙ    │  │ Эволюция     │
│ Состояния       │  │ InformationEngine│  │ Характера    │
└─────────────────┘  └──────────────────┘  └──────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│               ФАЗА 6: СОЦИАЛЬНАЯ ИЕРАРХИЯ                       │
│  ┌──────────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ HierarchyEngine  │  │   Gossip     │  │   Social     │     │
│  │      (#10)       │  │ Engine (#9)  │  │ Engine (#11) │     │
│  │                  │  │              │  │              │     │
│  │ С ИСПОЛЬЗОВАНИЕМ │  │  Слухи и     │  │  Нормы и     │     │
│  │ InformationEngine│  │  Credibility │  │  Конформизм  │     │
│  │   .perceptions   │  │              │  │              │     │
│  └──────────────────┘  └──────────────┘  └──────────────┘     │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│               ФАЗА 7: КУЛЬТУРНАЯ ПАМЯТЬ                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   Memory     │  │     Lore     │  │  Academics   │         │
│  │ Engine (#12) │  │ Engine (#13) │  │ Engine (#14) │         │
│  │              │  │              │  │              │         │
│  │ Мифы из      │  │  Легенды и   │  │ Отслеживание │         │
│  │ formative    │  │  Культурная  │  │ Активности   │         │
│  │ events       │  │  Память      │  │              │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│            ФАЗА 8: ОПТИМИЗАЦИЯ И ИНТЕГРАЦИЯ                     │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
│  │     State     │  │    Context    │  │     Norm      │      │
│  │  Versioning   │  │    Caching    │  │    Cache      │      │
│  │     (#30)     │  │     (#31)     │  │     (#32)     │      │
│  └───────────────┘  └───────────────┘  └───────────────┘      │
│                             │                                   │
│                             ▼                                   │
│                  ┌───────────────────────┐                      │
│                  │  UnifiedAnalyzer (#29)│ ◄─── ПОСЛЕДНИМ      │
│                  │  Координатор всех     │                      │
│                  │  движков              │                      │
│                  └───────────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

### Четырехуровневая Модель Сознания в v17

```
┌───────────────────────────────────────────────────────────┐
│ УРОВЕНЬ 1: ФЕНОМЕНОЛОГИЯ (QualiaEngine)                   │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Сырые телесные ощущения:                            │   │
│ │ • somatic_tension (напряжение)                      │   │
│ │ • valence (приятно/неприятно)                       │   │
│ │ • focus_aperture (фокус внимания)                   │   │
│ │ • energy_level (энергия)                            │   │
│ └─────────────────────────────────────────────────────┘   │
└───────────────────┬───────────────────────────────────────┘
                    │ qualia_state влияет на интерпретацию
                    ▼
┌───────────────────────────────────────────────────────────┐
│ УРОВЕНЬ 2: ПСИХОЛОГИЯ (InformationEngine)                 │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Субъективная интерпретация событий:                 │   │
│ │ • Один комплимент → "искренне" (valence > 0.7)      │   │
│ │ • Тот же комплимент → "саркастично" (valence < 0.3) │   │
│ │ • Perceptions: trust, respect, competence           │   │
│ └─────────────────────────────────────────────────────┘   │
└───────────────────┬───────────────────────────────────────┘
                    │ интерпретация формирует личность
                    ▼
┌───────────────────────────────────────────────────────────┐
│ УРОВЕНЬ 3: ЛИЧНОСТЬ (CrucibleEngine)                      │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Формирование характера и Я-концепции:               │   │
│ │ • personality (объективные черты)                   │   │
│ │ • self_concept (субъективное самовосприятие)        │   │
│ │ • formative_events (формирующие события)            │   │
│ └─────────────────────────────────────────────────────┘   │
└───────────────────┬───────────────────────────────────────┘
                    │ характер определяет социальное поведение
                    ▼
┌───────────────────────────────────────────────────────────┐
│ УРОВЕНЬ 4: СОЦИОЛОГИЯ (Hierarchy, Memory, Lore, Gossip)  │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Социальный капитал, репутация, мифы, легенды:       │   │
│ │ • HierarchyEngine (статусы: leader/outcast)         │   │
│ │ • MemoryEngine (коллективные мифы)                  │   │
│ │ • LoreEngine (культурные легенды)                   │   │
│ │ • GossipEngine (распространение слухов)             │   │
│ └─────────────────────────────────────────────────────┘   │
└───────────────────┬───────────────────────────────────────┘
                    │ социальные действия генерируют события
                    ▼
              ┌─────────────┐
              │  СОБЫТИЕ    │ ◄─── Цикл замыкается
              └─────────────┘
```

---

## ЗАКЛЮЧЕНИЕ

Этот мастер-план является **единственным источником правды** для разработки Project Lincoln v17.

**Ключевые положения:**

1. **Архитектура:** Единый объект `LC` в `Library.txt` с логически изолированными движками
2. **Порядок:** Строгая последовательность внедрения согласно графу зависимостей
3. **Критическая фаза:** QualiaEngine → InformationEngine БЕЗ ПЕРЕРЫВА, ДО социальных систем
4. **Тестирование:** После каждого компонента — обязательный запуск в игре
5. **Принцип:** Код с чистого листа, один движок за раз, никаких параллельных разработок

**Следование этому плану гарантирует:**
- Отсутствие технического долга
- Сохранение всех инноваций v16
- Инкрементальную разработку с постоянным контролем
- Успешную реализацию Project Lincoln v17

---

**КОНЕЦ ДОКУМЕНТА**

**Версия:** 1.0  
**Последнее обновление:** 25 октября 2025
