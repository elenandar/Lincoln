# MASTER PLAN v17
## Единый и Финальный План Разработки "Проекта Линкольн v17"

**Версия:** 1.0  
**Дата:** 13 октября 2025  
**Статус:** Канонический план разработки  
**Основано на:**
- v17.0/V16_MECHANICS_AUDIT.md
- v17.0/АЛЬТЕРНАТИВНАЯ_ДОРОЖНАЯ_КАРТА_v17.md
- v17.0/DEPENDENCY_GRAPH_VISUALIZATION.md
- v17.0/v17.0_V17_DEVELOPMENT_ROADMAP.md

---

## Содержание

1. [Философия и Принципы Разработки](#философия-и-принципы-разработки)
2. [Архитектурное Обоснование](#архитектурное-обоснование)
3. [Поэтапный План Разработки](#поэтапный-план-разработки)
   - [Фаза 1: Инфраструктура](#фаза-1-инфраструктура)
   - [Фаза 2: Физический Мир](#фаза-2-физический-мир)
   - [Фаза 3: Базовые Данные](#фаза-3-базовые-данные)
   - [Фаза 4: Сознание — КРИТИЧЕСКАЯ ФАЗА](#фаза-4-сознание--критическая-фаза)
   - [Фаза 5: Социальная Динамика](#фаза-5-социальная-динамика)
   - [Фаза 6: Социальная Иерархия](#фаза-6-социальная-иерархия)
   - [Фаза 7: Культурная Память](#фаза-7-культурная-память)
   - [Фаза 8: Оптимизация и Интеграция](#фаза-8-оптимизация-и-интеграция)
4. [Критические Правила](#критические-правила)
5. [Визуализация Графа Зависимостей](#визуализация-графа-зависимостей)

---

## Философия и Принципы Разработки

Разработка v17 — это не исправление v16, а её **перерождение**. Мы сохраняем блестящую архитектуру и концепции, но строим их заново на прочном, проверенном фундаменте.

### Основные Принципы

1. **Начать с Нуля ("Нулевая Система")**
   - Первым шагом является создание абсолютно пустых, но рабочих скриптов
   - Скрипты должны успешно загружаться в игру, не влияя на неё
   - Это наша точка отсчета

2. **Один Движок за Раз**
   - Мы внедряем системы строго по одной, в порядке, определенном этим планом
   - Никаких параллельных разработок
   - Каждая система должна быть полностью протестирована перед переходом к следующей

3. **Код с Чистого Листа**
   - Мы не копируем код из v16
   - Мы берем *идею* из аудиторского отчета и пишем её реализацию заново
   - Адаптируем под текущую реальность AI Dungeon

4. **Постоянное Тестирование в Игре**
   - После внедрения **каждого** компонента проводится обязательный запуск в игре
   - Проверка стабильности и корректности работы
   - Любая ошибка — немедленный приоритет

5. **Архитектурная Чистота**
   - Избегаем технического долга
   - Внедряем зависимости в правильном порядке
   - Одна реализация, одна версия тестов

6. **Сохранение Ключевых Инноваций v16**
   - Четырехуровневая модель сознания
   - Субъективная интерпретация событий
   - Репутация через восприятия
   - Легенды и мифы как культурная память

---

## Архитектурное Обоснование

### Почему Альтернативная Дорожная Карта?

После глубокого анализа всех 40 систем v16 и построения полного графа зависимостей установлено:

**Существующая дорожная карта функционально корректна, но создает технический долг из-за неоптимального порядка внедрения систем сознания.**

### Ключевое Решение

**QualiaEngine и InformationEngine должны быть внедрены ДО социальных систем (RelationsEngine, HierarchyEngine), а не после.**

### Обоснование

1. **Блокирующая зависимость:** InformationEngine не может функционировать без QualiaEngine
   \`\`\`javascript
   InformationEngine.interpret(character, event) {
     const valence = character.qualia_state.valence;  // ← CRASH if QualiaEngine not implemented
   }
   \`\`\`

2. **Функциональная зависимость:** RelationsEngine и HierarchyEngine нуждаются в InformationEngine для субъективной интерпретации
   \`\`\`javascript
   // RelationsEngine with InformationEngine
   const interpretation = InformationEngine.interpret(from, event);
   modifier *= interpretation.multiplier;
   \`\`\`

3. **Сохранение инноваций v16:** Репутация через субъективные восприятия — ключевая инновация, которая требует InformationEngine с первого дня

### Что мы избегаем

❌ **Технический долг:** Не нужно переписывать код после первого внедрения  
❌ **Двойная работа:** Не нужно создавать сначала простую версию, потом расширенную  
❌ **Потеря инноваций:** Не теряем ключевые архитектурные решения v16  

---

## Поэтапный План Разработки

### Фаза 1: Инфраструктура

**Срок:** 1-2 дня  
**Цель:** Создать базовый каркас для управления состоянием и отладки. Получить возможность "общаться" с системой через команды.

| № | Компонент | Назначение из V16 Аудита | Задачи для v17 (Минимальная реализация) | Команды для Тестирования | Критерий Успеха |
|---|---|---|---|---|---|
| 1.1 | **lcInit & State Management** (#33) | Централизованная инициализация состояния с lazy initialization | Создать \`Library.js\` с функцией \`LC.lcInit()\`, которая создает и возвращает объект \`state.lincoln\` с базовой структурой. Инициализировать \`turn\`, \`stateVersion\`, пустые объекты для всех будущих движков. | - | Игра загружается без ошибок. В \`state.shared\` появляется объект \`lincoln\` с инициализированными полями. |
| 1.2 | **System Messages** | Утилиты для форматирования системных сообщений | Создать утилиты \`LC.sysLine()\` и \`LC.sysBlock()\` для форматирования системных сообщений. \`Output.js\` должен уметь их отображать. | - | Сообщения, добавленные в очередь, корректно отображаются в выводе. |
| 1.3 | **CommandsRegistry** (#24) | Реестр всех слэш-команд системы | Создать \`LC.CommandsRegistry\` (пустой \`Map\`). \`Input.js\` должен парсить текст, находить команды (\`/\`) и пытаться их выполнить. Добавить команду \`/ping\` → \`pong\`. | \`/ping\` | При вводе \`/ping\` система отвечает \`pong\` через системное сообщение. |
| 1.4 | **currentAction** (#34) | Объектная модель действий (замена флагов) | Внедрить объект \`L.currentAction\` для отслеживания типа действия (\`story\`, \`command\`, \`retry\`, \`continue\`). Установка правильного типа в \`Input.js\`. | - | При вводе команды в \`L.currentAction.type\` устанавливается \`command\`. При story-вводе — \`story\`. |
| 1.5 | **LC.Tools** (#19) | Утилиты безопасности (защита от ReDoS) | Создать \`LC.Tools.safeRegexMatch(text, regex, timeout)\` с таймаутом по умолчанию 100ms. | - | Функция выполняется и возвращает результат или null при таймауте. |
| 1.6 | **LC.Utils** (#20) | Вспомогательные функции | Создать \`LC.Utils\` с функциями \`toNum(x, default)\`, \`toStr(x)\`, \`toBool(x, default)\` для безопасного преобразования типов. | - | Функции корректно преобразуют типы и возвращают defaults при ошибках. |
| 1.7 | **LC.Flags** (#21) | Фасад совместимости для старого API | Создать \`LC.Flags\` с функциями \`clearCmd()\`, \`setCmd()\`, \`queueRecap()\`, \`queueEpoch()\` — заглушки для совместимости. | - | Функции существуют и вызываются без ошибок. |
| 1.8 | **LC.Drafts** (#22) | Управление черновиками (recap/epoch) | Создать базовые структуры для хранения drafts: \`L.recapDraft\`, \`L.epochDraft\`. Функции \`applyRecapDraft()\`, \`applyEpochDraft()\` (заглушки). | - | Структуры существуют в state. |
| 1.9 | **LC.Turns** (#23) | Управление счетчиком ходов | Создать функции \`LC.Turns.incIfNeeded(L)\` (инкремент хода для story), \`turnSet(n)\`, \`turnUndo(n)\`. | - | Счетчик \`L.turn\` корректно инкрементируется при story-действиях, не меняется при командах. |

**Результат Фазы 1:** У нас есть "скелет" системы. Он ничего не симулирует, но загружается, управляет состоянием и позволяет нам добавлять отладочные команды.

**Команды тестирования:** \`/ping\`, \`/debug on\`

---

### Фаза 2: Физический Мир

**Срок:** 1-2 дня  
**Цель:** Заложить основы пространства и времени. Мир перестает быть статичным.

| № | Компонент | Назначение из V16 Аудита | Задачи для v17 (Минимальная реализация) | Команды для Тестирования | Критерий Успеха |
|---|---|---|---|---|---|---|
| 2.1 | **TimeEngine** (#7) | Отслеживание календарного времени и обработка временных скачков | Реализовать базовый счетчик ходов (\`L.turn\`). \`Output.js\` инкрементирует его на каждом сюжетном действии. Реализовать базовую структуру \`L.time\` (день, время суток). Создать функции \`advance(steps, unit)\`, \`getTimeString()\`. | \`/time\`, \`/time set 5 День\` | Команда \`/time\` показывает текущий ход и день. Счетчик ходов корректно увеличивается. Команда \`/time set\` меняет время. |
| 2.2 | **EnvironmentEngine** (#8) | Симуляция окружения (локации и погода) | Реализовать структуру \`L.environment\` (погода, локация). Создать функции \`changeWeather(newWeather)\`, \`detectLocation(text)\` (ручная установка). \`Output.js\` не должен ничего анализировать автоматически пока. | \`/weather set rain\`, \`/location set classroom\` | Команды успешно меняют значения в \`L.environment\`. \`state\` сохраняется. |
| 2.3 | **ChronologicalKnowledgeBase (CKB)** (#18) | Привязка знаний к временным моментам | Реализовать структуру \`L.chronologicalKnowledge\`. Создать функции \`addKnowledge(text, source, importance)\`, \`getRecentKnowledge(limit)\`, \`getKnowledgeAtTime(day, timeOfDay)\`. | \`/ckb add "событие"\`, \`/ckb recent\` | Команды добавляют знания с временными метками. Можно получить недавние записи. |

**Результат Фазы 2:** В мире появилось время, которое течет, и окружение, которое мы можем изменять вручную.

**Команды тестирования:** \`/time\`, \`/weather set storm\`, \`/location set cafeteria\`

---

### Фаза 3: Базовые Данные

**Срок:** 2-3 дня  
**Цель:** Создать системы хранения фактов, целей и секретов — базовые данные о мире.

| № | Компонент | Назначение из V16 Аудита | Задачи для v17 (Минимальная реализация) | Команды для Тестирования | Критерий Успеха |
|---|---|---|---|---|---|---|
| 3.1 | **EvergreenEngine** (#1) | Извлечение и сохранение фактов, статусов, отношений, обязательств из повествования | Реализовать структуру \`L.evergreen\` (relations, status, facts, obligations). Создать функции для ручного добавления данных через команды. Базовые паттерны для автоматического анализа (опционально). Функции \`analyze(text, source)\`, \`normalizeCharName(name)\`, \`clear()\`. | \`/evergreen set fact "Максим знает правду"\`, \`/evergreen summary\` | Команды добавляют данные в категории. Команда summary показывает содержимое категорий. |
| 3.2 | **GoalsEngine** (#2) | Автоматическое обнаружение и трекинг целей персонажей с планами достижения | Реализовать структуру \`L.goals\`. Создать функции \`analyze(text)\` для обнаружения целей, \`generateBasicPlan(goalText)\`, \`updateGoalStatus(character, goalText, newStatus)\`, \`getActiveGoals(character)\`. | \`/goal add Alice "выяснить правду"\`, \`/goal list Alice\`, \`/goal complete Alice 0\` | Команда добавляет цель персонажу с автоматическим планом из 3 шагов. Можно просмотреть и изменить статус. |
| 3.3 | **KnowledgeEngine** (#6) | Управление секретами и фокусировкой сцены для дозированного раскрытия информации | Реализовать структуру \`L.secrets\`. Создать функции \`addSecret(secretText, knownBy, importance)\`, \`setSceneFocus(characters)\`, \`getVisibleSecrets()\`, \`revealSecret(secretId, character)\`. | \`/secret high Alice :: "Директор подделал документы"\`, \`/focus Alice Bob\`, \`/secret reveal secret_1 Bob\` | Команды добавляют секреты, управляют фокусом сцены. Раскрытие секрета добавляет персонажа в knownBy. |

**Результат Фазы 3:** Система может хранить и управлять базовыми данными о мире: факты, цели персонажей, секреты.

**Команды тестирования:** \`/evergreen summary\`, \`/goal list Alice\`, \`/secret list\`

---

### Фаза 4: Сознание — КРИТИЧЕСКАЯ ФАЗА

**Срок:** 3-5 дней (САМЫЙ СЛОЖНЫЙ ЭТАП)  
**Цель:** Реализовать ключевую инновацию проекта — внутренний мир персонажей. Феноменология и субъективная реальность.

⚠️ **КРИТИЧЕСКОЕ ПРАВИЛО:** Эти системы должны быть внедрены **ПОСЛЕДОВАТЕЛЬНО** и **БЕЗ ПЕРЕРЫВА**. Никакие другие движки не должны внедряться между QualiaEngine и InformationEngine.

| № | Компонент | Назначение из V16 Аудита | Задачи для v17 (Минимальная реализация) | Команды для Тестирования | Критерий Успеха |
|---|---|---|---|---|---|---|
| 4.1 | **QualiaEngine** (#15) — ПЕРВЫМ | Симуляция сырых телесных ощущений — базовый слой сознания. Феноменальное ядро (Уровень 1) | Реализовать структуру \`L.characters[name].qualia_state\` (somatic_tension, valence, focus_aperture, energy_level). Создать функцию \`resonate(character, event)\` для трансляции событий в ощущения. Функцию \`runGroupResonance()\` для эмоциональной контагиозности. | \`/qualia set Alice valence 0.8\`, \`/qualia set Alice tension 0.3\`, \`/qualia show Alice\` | Команды изменяют внутреннее феноменальное состояние персонажа. Команда show отображает текущие значения всех квалиа. |
| 4.2 | **InformationEngine** (#5) — СРАЗУ ПОСЛЕ | Интерпретация событий через призму феноменального состояния персонажа (qualia_state). Субъективная реальность (Уровень 2) | **[СЛОЖНЫЙ ЭТАП]** Написать функцию \`interpret(character, event)\`. Она должна принимать событие (например, \`{type: 'praise', text: 'комплимент'}\`) и возвращать разную интерпретацию в зависимости от \`qualia_state.valence\`. Высокая valence → искренняя интерпретация, низкая → саркастичная. Создать структуру \`character.perceptions[otherName]\` (trust, respect, competence). Функция \`updatePerception(observer, subject, interpretation)\`. | \`/interpret Alice praise\`, \`/interpret Alice praise\` (с разной valence), \`/perception show Alice Bob\` | Команда \`/interpret Alice praise\` выводит РАЗНЫЙ текст интерпретации в зависимости от текущей valence Алисы. Восприятия (perceptions) сохраняются и могут быть просмотрены. |

**Результат Фазы 4:** Персонажи обретают внутренний мир. Мы можем симулировать, как их "ощущения" влияют на восприятие событий. Одно и то же событие интерпретируется по-разному в зависимости от феноменального состояния.

**Критерий успеха фазы:** 
1. QualiaEngine функционирует и изменяет qualia_state
2. InformationEngine ЧИТАЕТ qualia_state и выдает разные результаты при разных значениях
3. Тестирование: установить valence=0.9, выполнить \`/interpret Alice praise\` → получить "искренне". Установить valence=0.2, выполнить снова → получить "саркастично"

**Почему критично:**
- InformationEngine НЕ МОЖЕТ функционировать без QualiaEngine (блокирующая зависимость)
- Откладывать InformationEngine = создавать заглушки = бессмысленная работа
- Между ними НЕ должно быть других движков
- Социальные системы нуждаются в InformationEngine с первого дня

**Команды тестирования:** 
\`\`\`
/qualia set Alice valence 0.9
/interpret Alice praise
# Ожидание: "Алиса интерпретирует комплимент как искренний"

/qualia set Alice valence 0.2
/interpret Alice praise
# Ожидание: "Алиса интерпретирует комплимент как саркастичный"
\`\`\`

---

### Фаза 5: Социальная Динамика

**Срок:** 3-4 дня  
**Цель:** Ввести базовые социальные взаимодействия — отношения, настроения, формирование личности. Интегрировать с InformationEngine.

| № | Компонент | Назначение из V16 Аудита | Задачи для v17 (Минимальная реализация) | Команды для Тестирования | Критерий Успеха |
|---|---|---|---|---|---|---|
| 5.1 | **MoodEngine** (#3) | Обнаружение и трекинг эмоциональных состояний персонажей с экспирацией | Реализовать структуру \`L.character_status[name]\` (mood, reason, expires). Создать функцию \`analyze(text)\` для детекции настроений. Интеграция с QualiaEngine для прямых изменений qualia_state при сильных событиях (public_accusation, public_humiliation). | \`/mood set Alice angry "был оскорблен"\`, \`/mood show Alice\`, автоанализ текста | Команда устанавливает настроение с автоэкспирацией через N ходов. При сильных событиях автоматически меняется qualia_state. |
| 5.2 | **RelationsEngine** (#4) — С InformationEngine | Трекинг и обновление отношений между персонажами с субъективной интерпретацией | Реализовать структуру \`L.relations\`. Создать функции \`getRelation(from, to)\`, \`updateRelation(from, to, modifier, options)\` **С интеграцией InformationEngine**. При обновлении отношения использовать \`InformationEngine.interpret()\` для субъективной интерпретации события. Шкала: -100 (ненависть) до +100 (любовь). Функция \`analyze(text)\` для обнаружения социальных действий. | \`/relation set Alice Bob 50\`, \`/relation modify Alice Bob +10 praise\`, автоанализ социальных действий | Команда успешно создает/изменяет отношения. Автоанализ текста обнаруживает действия (поцелуй, удар, предательство) и обновляет отношения С УЧЕТОМ субъективной интерпретации через InformationEngine. |
| 5.3 | **CrucibleEngine** (#16) | Эволюция характера через опыт и создание self-concept (Я-концепции). Формирование личности (Уровень 3) | Реализовать структуру \`L.characters[name].self_concept\` (perceived_trust, perceived_bravery, perceived_idealism, perceived_aggression). Написать функции \`analyzeEvent(eventData)\`, \`_handleRelationChange()\`, \`_handleRumorSpread()\`. Предательство → self_concept.trust↓, aggression↑. Архивация формирующих событий в \`formative_events\`. Уведомление MemoryEngine. | \`/event trigger Alice betrayal\`, \`/self show Alice\` | После команды значения в \`self_concept\` Алисы изменяются. Экстремальные события архивируются. |

**Результат Фазы 5:** Персонажи взаимодействуют социально. Отношения обновляются автоматически с учетом субъективной интерпретации. Личность персонажей эволюционирует через опыт.

**Критерий успеха:** Автоматический анализ текста с описанием социального действия (например, "Алиса похвалила Боба") обновляет отношения между персонажами, используя InformationEngine для контекстной интерпретации. Разные персонажи интерпретируют одно и то же действие по-разному.

**Команды тестирования:** \`/relation show Alice Bob\`, \`/mood show Alice\`, \`/self show Alice\`

---

### Фаза 6: Социальная Иерархия

**Срок:** 2-3 дня  
**Цель:** Ввести динамическую социальную структуру — иерархию, слухи, нормы. Интегрировать с InformationEngine для репутации через восприятия.

| № | Компонент | Назначение из V16 Аудита | Задачи для v17 (Минимальная реализация) | Команды для Тестирования | Критерий Успеха |
|---|---|---|---|---|---|---|
| 6.1 | **HierarchyEngine** (#10) — С InformationEngine | Динамическая социальная структура на основе капитала и репутации через субъективные восприятия | Реализовать структуру \`L.characters[name].social.capital\`, \`social.status\`. Создать функции \`recalculateStatus()\`, \`updateCapital(character, eventData)\`, \`applyReputationShock()\`. **Ключевая инновация v16:** \`_getAverageWitnessRespect(character)\` — расчет репутации через InformationEngine.perceptions. Статусы: leader (>100), respected (50-100), neutral (10-50), outcast (<10). | \`/capital set Alice 110\`, \`/capital show Alice\`, \`/hierarchy recalc\` | После выполнения команды статус персонажа Alice меняется на \`leader\`. Функция \`_getAverageWitnessRespect()\` использует InformationEngine для расчета репутации через субъективные восприятия свидетелей. |
| 6.2 | **GossipEngine** (#9) | Автоматическое создание, распространение и искажение слухов | Реализовать структуру \`L.rumors\`. Создать функции \`analyze(text)\` для обнаружения событий достойных слухов, \`createRumor(event, witnesses)\`, \`Propagator.spreadRumor(rumorId, from, to)\`, \`addDistortion(rumor, witness)\`. Типы: betrayal, fight, romance, scandal, achievement. Leaders распространяют эффективнее (credibilityMultiplier=1.5). Искажение зависит от отношений. | \`/rumor add "предал друзей" about Alice\`, \`/rumor spread rumor_1 Alice Bob\`, \`/rumor list\` | Команда добавляет новый слух в массив \`L.rumors\`. Распространение слуха добавляет персонажа в knownBy с возможными искажениями. |
| 6.3 | **SocialEngine** (#11) | Эволюция социальных норм и отслеживание конформизма | Реализовать структуру \`L.society.norms\` (respect, honesty, loyalty, academic_integrity, punctuality). Создать функции \`detectNormViolation(text)\`, \`strengthenNorm(normType, amount)\`, \`getNormStrength(normType)\`. Начальная сила: 0.5. Нарушение → +0.1 к силе нормы. Интеграция с MemoryEngine (мифы усиливают нормы). | \`/norm set respect 0.8\`, \`/norm show\`, автоанализ нарушений | Команда устанавливает силу нормы. Автоанализ обнаруживает нарушения и усиливает соответствующую норму. Влияет на расчет социального капитала. |

**Результат Фазы 6:** Появляется динамическая социальная структура. Персонажи имеют статусы (лидер, изгой). Слухи распространяются и искажаются. Нормы формируются и влияют на поведение. **Репутация рассчитывается через субъективные восприятия (ключевая инновация v16).**

**Критерий успеха:** Репутация персонажа рассчитывается через субъективные восприятия свидетелей (InformationEngine.perceptions), а не через числовые отношения. Это сохраняет ключевую архитектурную инновацию v16.

**Команды тестирования:** \`/hierarchy show\`, \`/rumor list\`, \`/norm show\`

---

### Фаза 7: Культурная Память

**Срок:** 2-3 дня  
**Цель:** Ввести высший уровень симуляции — коллективную память, историю, культурные артефакты.

| № | Компонент | Назначение из V16 Аудита | Задачи для v17 (Минимальная реализация) | Команды для Тестирования | Критерий Успеха |
|---|---|---|---|---|---|---|
| 7.1 | **MemoryEngine** (#12) | Превращение архивных событий в коллективные мифы | Реализовать структуру \`L.myths\`. Создать функции \`runMythologization()\`, \`archiveFormativeEvent(eventData, character)\`, \`getDominantMyth()\`, \`getMythStrengthForTheme(theme)\`. Критерии мифа: событие старше 20 ходов, экстремальные изменения отношений (>80 points), завершение значимых целей, первый лидер. Структура мифа: type, theme (betrayal/loyalty/rise_to_power), hero, moral, strength, createdTurn, originalTurn. | \`/myth add "Миф о первом предательстве" hero Alice\`, \`/myth list\`, \`/myth dominant\` | Команда добавляет новый миф в \`L.myths\`. Функция \`runMythologization()\` автоматически создает мифы из старых архивных событий. Доминирующий миф определяет "zeitgeist". |
| 7.2 | **LoreEngine** (#13) | Автоматическая кристаллизация значимых событий в культурные артефакты (легенды) | Реализовать структуру \`L.lore\`. Создать функции \`observe(text)\`, \`calculateLorePotential(event)\` (4 фильтра), \`crystallize(event)\`, \`getRecentLegends(count)\`. 4 фильтра: Base Potential (dramaticMultiplier), Witness Amplification, Archetype Resonance (betrayal/sacrifice/triumph), Social Context. Порог: BASE_THRESHOLD=75. Cooldown: 200 ходов между легендами. Архивация при превышении LORE_ACTIVE_CAP. | \`/lore add "Легенда о великом предательстве"\`, \`/lore list\`, \`/lore recent 3\` | Команда добавляет новую легенду в \`L.lore\`. Автоанализ текста рассчитывает потенциал легенды через 4 фильтра и кристаллизует при превышении порога. Легенды усиливают эмоциональные реакции (Genesis Phase 2). |
| 7.3 | **AcademicsEngine** (#14) | Отслеживание академической активности персонажей | Реализовать структуру \`L.academics[character][subject]\` (effort: 0.0-1.0, lastUpdate: turn). Создать функции \`trackEffort(character, subject, effort)\`, \`getEffort(character, subject)\`, \`analyze(text)\`. Предметы: chemistry, math, literature, history, physics. Интеграция с GoalsEngine для академических целей. | \`/academics track Alice math 0.7\`, \`/academics show Alice\` | Команда записывает уровень усилий персонажа по предмету. Автоанализ обнаруживает академическую активность. Используется для создания легенд (academic_triumph). |
| 7.4 | **DemographicPressure** (#17) | Автоматическое введение новых персонажей при недостатке активных | Реализовать функции \`evaluate()\`, \`introduceCharacter(character)\`, \`calibrateToZeitgeist(character)\`. Критерии введения: менее 3 активных персонажей или 50% от L.population.size. Cooldown: 50 ходов. Калибровка: доминирующий миф влияет на личность нового персонажа (миф "betrayal" → низкий trust). | \`/demo introduce Bob\`, \`/demo evaluate\` | Команда вводит нового персонажа с калибровкой под текущий zeitgeist. Автоматическая оценка вызывает введение при недостатке персонажей. |

**Результат Фазы 7:** Система может хранить культурные артефакты (легенды и мифы), которые влияют на поведение персонажей. Коллективная память формируется автоматически. Новые персонажи калибруются под "дух времени" общества.

**Критерий успеха:** Легенды кристаллизуются автоматически при достаточной драматичности событий. Мифы формируются из архивных событий. Легенды усиливают эмоциональные реакции на похожие события (+30%).

**Команды тестирования:** \`/lore list\`, \`/myth dominant\`, \`/academics show Alice\`

---

### Фаза 8: Оптимизация и Интеграция

**Срок:** 2-3 дня  
**Цель:** Объединить все движки в единый конвейер анализа. Внедрить оптимизации производительности.

| № | Компонент | Назначение из V16 Аудита | Задачи для v17 (Минимальная реализация) | Команды для Тестирования | Критерий Успеха |
|---|---|---|---|---|---|---|
| 8.1 | **State Versioning** (#30) | Отслеживание изменений состояния для инвалидации кэша | Реализовать \`L.stateVersion = 0\`. Инкремент при любом изменении goals, character_status, relations, etc. Все движки, изменяющие состояние, должны делать \`L.stateVersion++\`. | - | При изменении любого движком состояния \`L.stateVersion\` увеличивается. |
| 8.2 | **Context Caching** (#31) | Избежание пересборки контекста при неизменном состоянии | Реализовать \`LC._contextCache\` в \`composeContextOverlay()\`. Проверка \`cached.stateVersion === L.stateVersion\` для cache hit. Инвалидация при изменении stateVersion. | \`/context build\`, повторный вызов без изменений | Первый вызов строит контекст. Второй вызов возвращает кэшированный результат (cache hit). |
| 8.3 | **Norm Cache** (#32) | Кэширование результатов нормализации текста | Реализовать \`LC._normUCached(s)\` с глобальным Map кэшем \`__NU_CACHE\`. LRU eviction при размере > 64. Opt-in через CONFIG.FEATURES.USE_NORM_CACHE. | - | Повторная нормализация одной строки возвращает кэшированный результат (ускорение). |
| 8.4 | **UnifiedAnalyzer** (#29) — ПОСЛЕДНИМ | Координация всех движков в один проход для оптимизации | **[ФИНАЛЬНАЯ ИНТЕГРАЦИЯ]** Создать \`LC.UnifiedAnalyzer\`. Функции \`collectPatterns()\`, \`analyzeText(text, actionType)\`. Порядок вызова движков: 1) TimeEngine, 2) EvergreenEngine, 3) GoalsEngine, 4) MoodEngine, 5) EnvironmentEngine, 6) GossipEngine, 7) RelationsEngine, 8) HierarchyEngine (conditional), 9) LoreEngine (последним). Один проход по тексту, централизованная обработка ошибок. | Автоанализ текста в Output.js | При вводе текста в Output.js автоматически вызываются все движки в правильном порядке через UnifiedAnalyzer. Все паттерны обрабатываются за один проход. |

**Результат Фазы 8:** Все движки координируются через единый конвейер. Система оптимизирована для производительности. Контекст кэшируется и инвалидируется умно.

**Критерий успеха:** UnifiedAnalyzer вызывает все движки в правильном порядке за один проход по тексту. Кэширование контекста работает и ускоряет повторные запросы.

**Команды тестирования:** Ввести текст с множественными паттернами, проверить что все движки отработали корректно.

---

## Критические Правила

### Правило #1: QualiaEngine → InformationEngine Последовательно

⚠️ **АБСОЛЮТНОЕ ТРЕБОВАНИЕ:**

1. **QualiaEngine должен быть внедрен ПЕРВЫМ** в Фазе 4
2. **InformationEngine должен быть внедрен СРАЗУ ПОСЛЕ** QualiaEngine
3. **НИКАКИЕ другие движки НЕ должны внедряться между ними**

**Причина:** InformationEngine не может функционировать без QualiaEngine (блокирующая зависимость).

\`\`\`javascript
// InformationEngine.interpret() - ПЕРВАЯ СТРОКА
const valence = character.qualia_state.valence;  // ← CRASH if QualiaEngine not implemented
\`\`\`

### Правило #2: InformationEngine До Социальных Систем

⚠️ **ТРЕБОВАНИЕ:**

RelationsEngine и HierarchyEngine должны быть внедрены **ПОСЛЕ** InformationEngine, чтобы сразу использовать субъективную интерпретацию.

**Что мы избегаем:**
- ❌ Создание простой версии RelationsEngine без InformationEngine
- ❌ Последующий рефакторинг для интеграции InformationEngine
- ❌ Двойная работа и технический долг

**Что мы получаем:**
- ✅ RelationsEngine С InformationEngine с первого дня
- ✅ HierarchyEngine С InformationEngine.perceptions с первого дня
- ✅ Одна реализация, одна версия тестов
- ✅ Сохранение ключевых инноваций v16

### Правило #3: UnifiedAnalyzer Последним

⚠️ **ТРЕБОВАНИЕ:**

UnifiedAnalyzer должен быть внедрен **ПОСЛЕДНИМ** в Фазе 8, после всех движков.

**Причина:** UnifiedAnalyzer координирует движки. Если движков нет, координировать нечего.

### Правило #4: Тестирование После Каждого Движка

⚠️ **ТРЕБОВАНИЕ:**

После внедрения **каждого** движка:
1. Запустить игру
2. Выполнить команды тестирования
3. Убедиться в отсутствии ошибок
4. Убедиться в корректности работы

**Любая ошибка — немедленный приоритет. Не переходить к следующему движку до устранения.**

---

## Визуализация Графа Зависимостей

\`\`\`
┌─────────────────────────────────────────────────────────────────┐
│                    PHASE 1: INFRASTRUCTURE                      │
│  lcInit, currentAction, CommandsRegistry, LC.Tools, LC.Utils,   │
│  LC.Flags, LC.Drafts, LC.Turns                                  │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                   PHASE 2: PHYSICAL WORLD                       │
│  TimeEngine, EnvironmentEngine, ChronologicalKnowledgeBase      │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                   PHASE 3: BASE DATA                            │
│  EvergreenEngine, GoalsEngine, KnowledgeEngine                  │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
╔═════════════════════════════════════════════════════════════════╗
║              ⚠️  PHASE 4: CONSCIOUSNESS — CRITICAL  ⚠️          ║
║                                                                 ║
║  ┌────────────────────────────────────────────────────────┐    ║
║  │              QualiaEngine (#15)                        │    ║
║  │         Phenomenal Core (Level 1)                      │    ║
║  │  • somatic_tension, valence, focus, energy             │    ║
║  └──────────────────────┬─────────────────────────────────┘    ║
║                         │ BLOCKING DEPENDENCY                   ║
║                         ▼                                       ║
║  ┌────────────────────────────────────────────────────────┐    ║
║  │          InformationEngine (#5)                        │    ║
║  │       Subjective Reality (Level 2)                     │    ║
║  │  • interpret(character, event) ← reads qualia_state    │    ║
║  │  • perceptions: trust, respect, competence             │    ║
║  └────────────────────────────────────────────────────────┘    ║
║                                                                 ║
║  ⚠️  These TWO systems MUST be implemented SEQUENTIALLY,       ║
║      WITHOUT INTERRUPTION, BEFORE social systems               ║
╚═════════════════════════════════════════════════════════════════╝
                               │
                               │ FUNCTIONAL DEPENDENCIES
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
┌─────────────────┐  ┌──────────────────┐  ┌──────────────┐
│  MoodEngine     │  │ RelationsEngine  │  │  Crucible    │
│     (#3)        │  │      (#4)        │  │ Engine (#16) │
│                 │  │ WITH Information │  │              │
│                 │  │ Engine           │  │              │
└─────────────────┘  └──────────────────┘  └──────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│               PHASE 6: SOCIAL HIERARCHY                         │
│  HierarchyEngine (WITH InformationEngine.perceptions),          │
│  GossipEngine, SocialEngine                                     │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│               PHASE 7: CULTURAL MEMORY                          │
│  MemoryEngine, LoreEngine, AcademicsEngine, DemographicPressure │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│               PHASE 8: OPTIMIZATION                             │
│  State Versioning, Context Caching, Norm Cache,                 │
│  UnifiedAnalyzer (LAST)                                         │
└─────────────────────────────────────────────────────────────────┘

Result: CLEAN ARCHITECTURE, NO TECHNICAL DEBT
\`\`\`

---

## Философское Резюме

Lincoln v17 — это не симулятор мира. Это **симулятор множества миров** — по одному для каждого сознания.

Повествование создается не из событий, а из **конфликта между субъективными реальностями**.

Каждый персонаж живет в своей интерпретации событий, окрашенной феноменальным состоянием (qualia), искаженной самовосприятием (self-concept), и формирующей коллективную память (myths & legends).

### Четырехуровневая Модель Сознания

\`\`\`
Событие → [1. Феноменология: QualiaEngine] → Ощущение
         ↓
         [2. Психология: InformationEngine] → Интерпретация
         ↓
         [3. Личность: CrucibleEngine] → Я-концепция/Характер
         ↓
         [4. Социология: Social/Memory Engines] → Действие в обществе
         ↓
         Обратная связь → Событие
\`\`\`

**Уровень 1 (QualiaEngine):** Сырые телесные ощущения  
**Уровень 2 (InformationEngine):** Интерпретация ощущений в смыслы  
**Уровень 3 (CrucibleEngine):** Формирование характера  
**Уровень 4 (Social/Memory Engines):** Социальный капитал и мифы

---

## Итоговая Таблица: Все 40 Систем

| № | Система | Фаза | Тип | Зависимости |
|---|---|---|---|---|
| 1 | lcInit | 1 | Infrastructure | - |
| 2 | System Messages | 1 | Infrastructure | lcInit |
| 3 | CommandsRegistry | 1 | Infrastructure | lcInit |
| 4 | currentAction | 1 | Infrastructure | lcInit |
| 5 | LC.Tools | 1 | Infrastructure | - |
| 6 | LC.Utils | 1 | Infrastructure | - |
| 7 | LC.Flags | 1 | Infrastructure | currentAction |
| 8 | LC.Drafts | 1 | Infrastructure | lcInit |
| 9 | LC.Turns | 1 | Infrastructure | lcInit, currentAction |
| 10 | TimeEngine | 2 | Physical World | lcInit |
| 11 | EnvironmentEngine | 2 | Physical World | lcInit |
| 12 | ChronologicalKnowledgeBase | 2 | Physical World | TimeEngine |
| 13 | EvergreenEngine | 3 | Base Data | lcInit, LC.Tools |
| 14 | GoalsEngine | 3 | Base Data | lcInit, LC.Tools |
| 15 | KnowledgeEngine | 3 | Base Data | lcInit |
| 16 | QualiaEngine | 4 | Consciousness | lcInit |
| 17 | InformationEngine | 4 | Consciousness | QualiaEngine (BLOCKING) |
| 18 | MoodEngine | 5 | Social Dynamics | QualiaEngine |
| 19 | RelationsEngine | 5 | Social Dynamics | InformationEngine (FUNCTIONAL) |
| 20 | CrucibleEngine | 5 | Social Dynamics | lcInit, RelationsEngine |
| 21 | HierarchyEngine | 6 | Social Hierarchy | InformationEngine (FUNCTIONAL) |
| 22 | GossipEngine | 6 | Social Hierarchy | HierarchyEngine |
| 23 | SocialEngine | 6 | Social Hierarchy | lcInit |
| 24 | MemoryEngine | 7 | Cultural Memory | CrucibleEngine |
| 25 | LoreEngine | 7 | Cultural Memory | lcInit, LC.Utils |
| 26 | AcademicsEngine | 7 | Cultural Memory | lcInit, GoalsEngine |
| 27 | DemographicPressure | 7 | Cultural Memory | MemoryEngine |
| 28 | State Versioning | 8 | Optimization | lcInit |
| 29 | Context Caching | 8 | Optimization | State Versioning |
| 30 | Norm Cache | 8 | Optimization | - |
| 31 | UnifiedAnalyzer | 8 | Optimization | ALL Engines |
| 32 | Safe Regex (Security) | - | Stability | LC.Tools |
| 33 | Data Growth Limits | - | Stability | Все движки |
| 34 | Type Validation | - | Stability | LC.Utils |
| 35 | Error Handling | - | Stability | Все движки |
| 36 | State Migration | - | State Management | lcInit |
| 37 | CONFIG | - | Configuration | - |
| 38 | Modular Structure | - | Architecture | - |
| 39 | Cascading Integration | - | Architecture | UnifiedAnalyzer |
| 40 | Integration Points | - | Architecture | Все движки |

**Всего:** 40 систем, 8 фаз, 0 технического долга.

---

## Заключение

Этот план является **единственным каноническим руководством** для разработки Project Lincoln v17.

Он синтезирует:
- ✅ Все 40 систем из V16_MECHANICS_AUDIT.md
- ✅ Оптимальную последовательность из АЛЬТЕРНАТИВНАЯ_ДОРОЖНАЯ_КАРТА_v17.md
- ✅ Визуализацию зависимостей из DEPENDENCY_GRAPH_VISUALIZATION.md
- ✅ Формат детализированных таблиц из V17_DEVELOPMENT_ROADMAP.md

**Критическое правило:** QualiaEngine и InformationEngine внедряются ПОСЛЕДОВАТЕЛЬНО, БЕЗ ПЕРЕРЫВА, ДО социальных систем.

**Результат:** Архитектурно чистая система без технического долга, сохраняющая все ключевые инновации v16.

---

**Конец мастер-плана.**
